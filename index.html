<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seguimiento QC</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --text: #f1f5f9;
            --success: #22c55e;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        h2 { color: var(--accent); margin-top: 0; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; }
        button { background: var(--accent); color: var(--bg); font-weight: bold; border: none; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        .check-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #334155; }
        .check-item:last-child { border: 0; }
        .check-item input[type="checkbox"] { width: 24px; height: 24px; accent-color: var(--success); }
        .hidden { display: none; }
        .aeronave-card { background: #334155; padding: 15px; border-radius: 8px; margin-top: 10px; }
        #camera-stream { width: 100%; border-radius: 8px; margin-top: 10px; background: black; }
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .photo-preview { width: 100%; border-radius: 4px; border: 2px solid var(--accent); }
    </style>
</head>
<body>

    <div id="setup-screen" class="card">
        <h2><i class="fas fa-user-shield"></i> Inicio de Turno</h2>
        <input type="text" id="user-name" placeholder="Nombre del Inspector">
        <input type="number" id="user-emp" placeholder="No. de Empleado">
        <select id="shift-select">
            <option value="Diurno">Turno Diurno</option>
            <option value="Nocturno">Turno Nocturno</option>
            <option value="Cursos">Cursos / Capacitación</option>
        </select>
        <button onclick="iniciarTurno()">INICIAR JORNADA</button>
    </div>

    <div id="main-app" class="hidden">
        <div class="card">
            <h2 id="display-shift-name">Checklist</h2>
            <div id="checklist-container"></div>
        </div>

        <div id="aeronaves-section" class="card">
            <h2><i class="fas fa-plane"></i> Liberación de Aeronaves</h2>
            <input type="text" id="matricula" placeholder="Matrícula (Ej: XA-ABC)">
            <div style="display:flex; align-items:center; gap:10px; margin: 10px 0;">
                <input type="checkbox" id="confirm-critico" style="width:20px;">
                <label style="font-size:0.8em; color:#94a3b8;">Confirmo revisión de 8 puntos críticos</label>
            </div>
            
            <button onclick="abrirCamara()" style="background:#94a3b8;"><i class="fas fa-camera"></i> Tomar Foto</button>
            <video id="camera-stream" class="hidden" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div id="photo-preview-container" class="photo-grid"></div>
            
            <button onclick="agregarAeronave()" style="margin-top:15px; background:var(--success);">GUARDAR AERONAVE</button>
            <div id="lista-aeronaves"></div>
        </div>

        <button onclick="finalizarTurno()" id="btn-finalizar" style="background:#f43f5e; color:white; font-size:1.2em; padding:20px;">
            <i class="fas fa-file-pdf"></i> FINALIZAR Y GENERAR REPORTE
        </button>
    </div>

    <script>
        let userName = '', userEmp = '', currentShift = '';
        let checks = {};
        let aeronaves = [];
        let tempPhotos = [];

        const checklistData = {
            'Diurno': ['Revisión de Herramental', 'Limpieza de Área', 'Entrega de Turno', 'Validación de Formatos'],
            'Nocturno': ['Revisión de Iluminación', 'Cierre de Hangares', 'Inventario de Consumibles', 'Reporte de Novedades'],
            'Cursos': ['Asistencia a Aula', 'Examen de Módulo', 'Firma de Bitácora']
        };

        function iniciarTurno() {
            userName = document.getElementById('user-name').value;
            userEmp = document.getElementById('user-emp').value;
            currentShift = document.getElementById('shift-select').value;

            if(!userName || !userEmp) {
                alert("Por favor ingresa nombre y número de empleado");
                return;
            }

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('display-shift-name').innerText = "Checklist " + currentShift;

            if(currentShift === 'Cursos') document.getElementById('aeronaves-section').classList.add('hidden');

            const container = document.getElementById('checklist-container');
            checklistData[currentShift].forEach(item => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<span>${item}</span><input type="checkbox" onchange="toggleCheck('${item}')">`;
                container.appendChild(div);
            });
        }

        function toggleCheck(item) {
            checks[item] = !checks[item];
        }

        async function abrirCamara() {
            const video = document.getElementById('camera-stream');
            video.classList.remove('hidden');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            video.onclick = () => capturarFoto(stream);
            alert("Toca el video para capturar la foto");
        }

        function capturarFoto(stream) {
            const video = document.getElementById('camera-stream');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const data = canvas.toDataURL('image/jpeg', 0.5);
            tempPhotos.push(data);
            
            const img = document.createElement('img');
            img.src = data;
            img.className = 'photo-preview';
            document.getElementById('photo-preview-container').appendChild(img);
            
            stream.getTracks().forEach(track => track.stop());
            video.classList.add('hidden');
        }

        function agregarAeronave() {
            const mat = document.getElementById('matricula').value.toUpperCase();
            const conf = document.getElementById('confirm-critico').checked;

            if(!mat || !conf) {
                alert("Falta matrícula o confirmar puntos críticos");
                return;
            }

            aeronaves.push({ matricula: mat, fotos: [...tempPhotos] });
            
            const div = document.createElement('div');
            div.className = 'aeronave-card';
            div.innerHTML = `<strong>${mat}</strong> - ${tempPhotos.length} fotos guardadas`;
            document.getElementById('lista-aeronaves').appendChild(div);

            // Limpiar
            document.getElementById('matricula').value = '';
            document.getElementById('confirm-critico').checked = false;
            document.getElementById('photo-preview-container').innerHTML = '';
            tempPhotos = [];
        }

        function finalizarTurno() {
            // 1. VALIDAR CHECKLIST
            const itemsRequired = checklistData[currentShift];
            for (let item of itemsRequired) {
                if (!checks[item]) {
                    alert("PENDIENTE: Debes marcar todos los puntos del Checklist: " + item);
                    return;
                }
            }

            // 2. VALIDAR AERONAVES (Solo en operativos)
            if (currentShift !== 'Cursos' && aeronaves.length === 0) {
                alert("PENDIENTE: Debes registrar y GUARDAR al menos una aeronave.");
                return;
            }

            generarPDF();
        }

        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("REPORTE DE SEGUIMIENTO QC", 20, 20);
            doc.setFontSize(12);
            doc.text(`Inspector: ${userName} (#${userEmp})`, 20, 30);
            doc.text(`Turno: ${currentShift}`, 20, 37);
            doc.text(`Fecha: ${new Date().toLocaleString()}`, 20, 44);

            doc.text("ESTADO DE CHECKLIST:", 20, 55);
            let y = 62;
            checklistData[currentShift].forEach(item => {
                doc.text(`[OK] ${item}`, 25, y);
                y += 7;
            });

            if(currentShift !== 'Cursos') {
                doc.addPage();
                doc.text("AERONAVES LIBERADAS:", 20, 20);
                let ay = 30;
                aeronaves.forEach(aero => {
                    doc.text(`Matrícula: ${aero.matricula}`, 20, ay);
                    ay += 10;
                    aero.fotos.forEach((f, i) => {
                        if(ay > 250) { doc.addPage(); ay = 20; }
                        doc.addImage(f, 'JPEG', 20, ay, 50, 40);
                        ay += 45;
                    });
                    ay += 10;
                });
            }

            doc.save(`Reporte_QC_${userEmp}_${Date.now()}.pdf`);
            alert("PDF Generado con éxito. Buen trabajo.");
            location.reload();
        }
    </script>
</body>
</html>
