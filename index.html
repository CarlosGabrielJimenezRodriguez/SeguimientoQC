<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Seguimiento QC - Reporte FotogrÃ¡fico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --bg: #0f172a;
    --panel: rgba(30, 41, 59, 0.7);
    --accent: #38bdf8;
    --text: #f8fafc;
    --muted: #94a3b8;
    --card: #020617;
    --danger: #ef4444;
    --success: #22c55e;
    --warning: #f59e0b;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", system-ui, sans-serif;
    background: radial-gradient(circle at top, #1e293b, #0f172a);
    background-attachment: fixed;
    color: var(--text);
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }

  main {
    width: 100%;
    max-width: 450px;
    margin: 15px;
    background: var(--panel);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 24px;
    padding: 20px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
    position: relative;
  }

  h1 { text-align: center; font-size: 20px; margin-bottom: 20px; color: var(--accent); }
  h3 { color: var(--accent); font-size: 16px; margin-top: 25px; margin-bottom: 10px; }

  form { display: grid; gap: 12px; }
  label { font-size: 13px; color: var(--muted); font-weight: 600; margin-left: 5px; }

  input, textarea, select {
    background: #020617;
    border: 1px solid #1e293b;
    color: var(--text);
    padding: 12px;
    border-radius: 12px;
    font-size: 15px;
    width: 100%;
    box-sizing: border-box;
  }

  button {
    padding: 14px;
    border: none;
    border-radius: 14px;
    background: var(--accent);
    color: #020617;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    margin-top: 10px;
  }

  .btn-outline { background: #020617; color: var(--text); border: 1px solid #1e293b; }
  .btn-danger { background: var(--danger); color: white; }
  .btn-success { background: var(--success); color: #020617; }
  .btn-warning { background: var(--warning); color: #020617; }

  #listaChecklist > div {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: rgba(255, 255, 255, 0.03);
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  #listaChecklist input[type="checkbox"] {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
    margin: 0;
    margin-top: 2px;
    accent-color: var(--accent);
  }

  /* ESTILOS DE LA LIBERACIÃ“N */
  .check-item-lib {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px;
    margin-top: 12px;
    padding: 15px !important;
    border: 1px solid #334155 !important;
    background: rgba(15, 23, 42, 0.6) !important;
    border-radius: 15px;
    transition: border-color 0.3s ease, background 0.3s ease;
  }
     
  .check-item-lib.liberado-ok {
    border-color: var(--success) !important;
    background: rgba(34, 197, 94, 0.1) !important;
  }

  .check-item-lib input[type="text"] {
    border: 1px solid var(--accent);
    text-align: center;
    font-weight: bold;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .mini-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 10px;
  }

  .mini-option {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    font-size: 10px;
    color: #cbd5e1;
    line-height: 1.2;
  }

  .mini-option input {
    width: 14px;
    height: 14px;
    margin: 0;
    cursor: pointer;
  }

  .galeria-lib {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 5px 0;
    min-height: 20px;
  }
     
  .img-wrapper { position: relative; flex-shrink: 0; }
  .img-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid var(--accent); cursor: pointer; }
  .btn-remove-img { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }

  .btn-camera { background: #1e293b; color: var(--accent); padding: 10px; font-size: 13px; border: 1px dashed var(--accent); border-radius: 10px; }

  .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
  .stat-card { background: rgba(2, 6, 23, 0.5); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(56, 189, 248, 0.2); }
  .stat-value { font-size: 1.5rem; font-weight: bold; display: block; color: var(--accent); }
  .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; }

  section { animation: fadeIn 0.4s ease-in-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .editor-item { display: flex; gap: 8px; margin-bottom: 8px; animation: slideIn 0.2s ease-out; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

  /* NUEVOS ESTILOS: VISOR Y MODAL DE EDICIÃ“N */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 1000;
    display: none; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
  }
  .modal-img { max-width: 95%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(56, 189, 248, 0.5); }
  .close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 1001; }

  .modal-editor-content {
    background: #1e293b; padding: 20px; border-radius: 20px;
    width: 90%; max-width: 400px; border: 1px solid var(--accent);
    max-height: 90vh; overflow-y: auto;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<div id="visorImg" class="modal-overlay" onclick="cerrarVisor()">
  <span class="close-modal">&times;</span>
  <img id="imgFull" class="modal-img">
</div>

<div id="modalEditor" class="modal-overlay">
  <div class="modal-editor-content">
    <h3><i class="fas fa-edit"></i> Editar Registro</h3>
    <label>Observaciones</label>
    <textarea id="editObservaciones" rows="4"></textarea>
    
    <label style="margin-top:10px;">Fotos (General/Observaciones)</label>
    <div id="editGaleria" class="galeria-lib" style="flex-wrap: wrap;"></div>
    
    <button type="button" class="btn-camera" onclick="document.getElementById('fileEdit').click()" style="margin-top:10px;">
        <i class="fas fa-plus"></i> AÃ±adir Foto
    </button>
    <input type="file" id="fileEdit" accept="image/*" style="display:none" onchange="addFotoEdicion()">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
        <button onclick="guardarEdicion()" class="btn-success"><i class="fas fa-save"></i> Guardar</button>
        <button onclick="cerrarEditor()" class="btn-outline">Cancelar</button>
    </div>
  </div>
</div>

<main>
  <section id="pantallaInicio">
    <h1><i class="fas fa-clipboard-check"></i> Seguimiento QC</h1>
    <form id="formInicio">
      <label>Colaborador</label>
      <input id="nombre" placeholder="Nombre completo" required>
      <label>No. Empleado</label>
      <input id="empleado" placeholder="ID" required>
      <label>Fecha y Entrada</label>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <input type="date" id="fecha" required>
        <input type="time" id="horaEntrada" required>
      </div>
      <button type="submit" id="btnIniciar"><i class="fas fa-play"></i> Iniciar jornada</button>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button type="button" onclick="irAHistorial()" class="btn-outline"><i class="fas fa-history"></i> Historial</button>
        <button type="button" onclick="irAConfig()" class="btn-outline" style="border-color: #475569;"><i class="fas fa-cog"></i> Configurar</button>
      </div>
    </form>
  </section>

  <section id="pantallaConfig" style="display:none;">
    <h1><i class="fas fa-tasks"></i> Editar Checklists</h1>
    <label>Seleccionar Lista</label>
    <select id="selectTipoConfig" onchange="renderEditor()" style="margin-bottom: 15px;">
        <option value="Diurno">Turno Diurno</option>
        <option value="Nocturno">Turno Nocturno</option>
        <option value="Curso">CapacitaciÃ³n</option>
        <option value="Extra">Tiempo Extra</option>
        <option value="Liberacion">Items de LiberaciÃ³n (Aeronave)</option>
    </select>
      
    <div id="editorTareas" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px; padding-right: 5px;"></div>
      
    <button onclick="agregarTarea()" class="btn-outline"><i class="fas fa-plus"></i> AÃ±adir Item</button>
    <button onclick="guardarConfig()" class="btn-success"><i class="fas fa-save"></i> Guardar Cambios</button>
    <button onclick="volverAlInicioDesdeConfig()" class="btn-outline"><i class="fas fa-arrow-left"></i> Regresar</button>
  </section>

  <section id="pantallaMenu" style="display:none;">
    <h1>Tipo de jornada</h1>
    <div class="menu-opciones">
      <button onclick="seleccionarJornada('Diurno')" class="btn-outline"><i class="fas fa-sun"></i> Turno Diurno</button>
      <button onclick="seleccionarJornada('Nocturno')" class="btn-outline"><i class="fas fa-moon"></i> Turno Nocturno</button>
      <button onclick="seleccionarJornada('Curso')" class="btn-outline"><i class="fas fa-graduation-cap"></i> CapacitaciÃ³n</button>
    </div>
    <button onclick="volverAlInicio()" class="btn-outline"><i class="fas fa-arrow-left"></i> Regresar</button>
  </section>

  <section id="pantallaTiempoExtra" style="display:none;">
    <h1>Â¿Es tiempo extra?</h1>
    <button onclick="seleccionarTiempoExtra(true)"><i class="fas fa-check"></i> SÃ­, es extra</button>
    <button onclick="seleccionarTiempoExtra(false)" class="btn-outline"><i class="fas fa-times"></i> No</button>
    <button onclick="volverAJornada()" class="btn-outline"><i class="fas fa-arrow-left"></i> Regresar</button>
  </section>

  <section id="pantallaChecklist" style="display:none;">
    <h1>Checklist del Turno</h1>
    <div id="listaChecklist"></div>
     
    <label style="margin-top:20px; display:block;">Observaciones Generales</label>
    <textarea id="observacionesTurno" placeholder="Notas adicionales..."></textarea>
     
    <button type="button" class="btn-camera" onclick="document.getElementById('fileObservaciones').click()" style="margin-top:10px;">
        <i class="fas fa-camera"></i> AÃ±adir Foto a Observaciones
    </button>
    <input type="file" id="fileObservaciones" accept="image/*" style="display:none" onchange="addFotoObservaciones()">
    <div id="galeriaObservaciones" class="galeria-lib" style="margin-bottom:15px; margin-top:10px;"></div>
    <button onclick="validarChecklist()"><i class="fas fa-save"></i> Finalizar Turno</button>
    <button onclick="volverDesdeChecklist()" class="btn-outline"><i class="fas fa-arrow-left"></i> Regresar</button>
  </section>

  <section id="pantallaHistorial" style="display:none;">
    <h1>Resumen Mensual</h1>
    <input type="text" id="buscadorHistorial" onkeyup="filtrarHistorial()" placeholder="ðŸ” Buscar matrÃ­cula..." style="margin-bottom: 15px;">
    <div class="stats-container">
      <div class="stat-card"><i class="fas fa-calendar-alt"></i><span id="statJornadas" class="stat-value">0</span><span class="stat-label">Jornadas</span></div>
      <div class="stat-card"><i class="fas fa-star"></i><span id="statExtra" class="stat-value">0</span><span class="stat-label">T. Extra</span></div>
    </div>
    <div id="listaHistorial"></div>
    <button onclick="nuevaJornada()"><i class="fas fa-redo"></i> Nueva jornada</button>
    <button onclick="exportarPDF()" class="btn-success"><i class="fas fa-file-pdf"></i> PDF</button>
    <button onclick="eliminarHistorial()" class="btn-danger"><i class="fas fa-trash-alt"></i> Borrar Mes</button>
  </section>
</main>

<script>
// --- DATOS ---
const checklistsBase = {
  Diurno: [
    "Checar entrada", "Hacer Clock in", "FORMS FATIGA (overtime)", "Revisar paso de turno",
    "AsignaciÃ³n de trabajos QC", "VerificaciÃ³n de MARCHs", "Reporte de incoming",
    "Correo de paso de almacÃ©n (AMOS)", "Solo lunes: entrega certificados incoming",
    "Primero de mes: botiquÃ­nes HGR6/POS1", "Realizar incoming", "JUNTA 11:30 Revisar programaciÃ³n NLU,TLC, MEX", "InspecciÃ³n de WO con apego a manuales",
    "Herramientas calibrables WO", "Remanente trabajos abiertos", "Agregar tiempos AMOS",
    "Correo paso turno nocturno", "FORMS paso de turno", "Horario siguiente dÃ­a",
    "Reporte turno diurno almacÃ©n", "Revision sellos WO", "No rutinarios", "Correos de WO requeridos", "Carga de SPOT CHECK",
    "Liberar en Power Apps", "Pendientes almacÃ©n", "Realizar reportes NDT","AOG Realizar paso de turno y correo","FORMS OVERTIME", "FORMS PRIMA DOMINICAL/DIA FESTIVO",
    "Cargar Viaticos", "Clock out", "Checar salida"
  ],
  Nocturno: [
    "Checar entrada", "Hacer Clock in", "FORMS FATIGA (overtime)", "Revisar paso de turno",
    "AsignaciÃ³n QC pernocta", "Efectividades, MTOW, DD, MEL, CDL", "InspecciÃ³n de equipos NDT en base",
    "VerificaciÃ³n MARCHs", "Realizar incoming", "InspecciÃ³n de WO apego a manuales", "Herramientas calibrables en WO","Revision sellos WO",
    "Remanente trabajos abiertos", "Agregar tiempos AMOS", "Correos de WO requeridos", "carga de SPOT CHECK",
    "Correo paso de turno", "FORMS paso de turno", "Horario siguiente dÃ­a",
    "No rutinarios", "Realizar reportes NDT","AOG Realizar paso de turno y correo","Liberar en Power Apps", "Pendientes almacÃ©n", "FORMS OVERTIME",
    "FORMS PRIMA DOMINICAL/DIA FESTIVO", "Cargar Viaticos", "Clock out", "Checar salida"
  ],
  Curso: ["TIA, ID Empresa, INE, licencia, Examen Medico","Check-in hotel/vuelo", "Verificar Links curso", "Al culminar realizar forms de cursos", "Check-out hotel/vuelo"],
  Extra: ["Forms tiempo extra"],
  Liberacion: [
    "Diferidos con vigencia", "Bit Mantto ultimo folio", "Bit Sobre ultimo", "Tareas abiertas con remanente",
    "Componentes asentados", "Cierre diferido Mantto/Dif", "Trabajos completados", "Eq. Emergencia verificado",
    "Aeronavegabilidad vigente", "Sin reportes abiertos", "Niveles OK", "Accesos cerrados",
    "ENG/HCU/Seguros LG", "Sin limitantes"
  ]
};

let misChecklists = JSON.parse(localStorage.getItem("configChecklistsQC")) || checklistsBase;
if (!misChecklists.Liberacion) {
    misChecklists.Liberacion = checklistsBase.Liberacion;
    localStorage.setItem("configChecklistsQC", JSON.stringify(misChecklists));
}

let fotosAeronaves = { 1: [], 2: [], 3: [], 4: [] };
let fotosObservaciones = [];
// Variables para ediciÃ³n
let indiceEditando = -1;
let fotosEditando = [];

// --- CONFIG ---
function irAConfig() {
    document.getElementById("pantallaInicio").style.display = "none";
    document.getElementById("pantallaConfig").style.display = "block";
    renderEditor();
}

function renderEditor() {
    const tipo = document.getElementById("selectTipoConfig").value;
    const contenedor = document.getElementById("editorTareas");
    contenedor.innerHTML = "";
    misChecklists[tipo].forEach((tarea, index) => {
        contenedor.innerHTML += `
            <div class="editor-item">
                <input type="text" value="${tarea}" onchange="actualizarTarea('${tipo}', ${index}, this.value)">
                <button onclick="eliminarTarea('${tipo}', ${index})" style="width:45px; background:var(--danger); margin:0; padding:0;"><i class="fas fa-trash"></i></button>
            </div>
        `;
    });
}
function actualizarTarea(tipo, index, valor) { misChecklists[tipo][index] = valor; }
function eliminarTarea(tipo, index) { misChecklists[tipo].splice(index, 1); renderEditor(); }
function agregarTarea() { const tipo = document.getElementById("selectTipoConfig").value; misChecklists[tipo].push("Nuevo Ã­tem..."); renderEditor(); }
function guardarConfig() {
    localStorage.setItem("configChecklistsQC", JSON.stringify(misChecklists));
    alert("âœ… Listas actualizadas.");
}
function volverAlInicioDesdeConfig() {
    document.getElementById("pantallaConfig").style.display = "none";
    document.getElementById("pantallaInicio").style.display = "block";
}

// --- FLUJO ---
document.getElementById("formInicio").addEventListener("submit", function(e) {
  e.preventDefault();
  const datos = {
    nombre: document.getElementById("nombre").value.trim(),
    empleado: document.getElementById("empleado").value.trim(),
    fecha: document.getElementById("fecha").value,
    horaEntrada: document.getElementById("horaEntrada").value
  };
  localStorage.setItem("colaboradorQC", JSON.stringify(datos));
  document.getElementById("pantallaInicio").style.display = "none";
  document.getElementById("pantallaMenu").style.display = "block";
});

function seleccionarJornada(tipo){
  localStorage.setItem("tipoJornadaQC", tipo);
  document.getElementById("pantallaMenu").style.display = "none";
  if(tipo === "Curso"){
    localStorage.setItem("esTiempoExtraQC", "NO");
    document.getElementById("pantallaChecklist").style.display = "block";
    cargarChecklist();
  } else {
    document.getElementById("pantallaTiempoExtra").style.display = "block";
  }
}

function seleccionarTiempoExtra(esExtra){
  localStorage.setItem("esTiempoExtraQC", esExtra ? "SI" : "NO");
  document.getElementById("pantallaTiempoExtra").style.display = "none";
  document.getElementById("pantallaChecklist").style.display = "block";
  cargarChecklist();
}

function cargarChecklist() {
  const tipo = localStorage.getItem("tipoJornadaQC");
  const esExtra = localStorage.getItem("esTiempoExtraQC") === "SI";

  fotosObservaciones = [];
  renderGaleriaObservaciones();
  document.getElementById("observacionesTurno").value = "";
   
  let checklist = [...misChecklists[tipo]];
  if(esExtra && tipo !== "Curso") checklist = checklist.concat(misChecklists.Extra);

  const contenedor = document.getElementById("listaChecklist");
  contenedor.innerHTML = "";

  checklist.forEach((item, index) => {
    contenedor.innerHTML += `
      <div>
        <input type="checkbox" id="item${index}">
        <label for="item${index}">${item} <small id="hora${index}"></small></label>
      </div>`;
  });

  if (tipo !== "Curso") {
    contenedor.innerHTML += `<h3><i class="fas fa-shield-alt"></i> LiberaciÃ³n de Aeronaves</h3>`;
    const itemsLibDinamicos = misChecklists.Liberacion;
    for (let i = 1; i <= 4; i++) {
        let miniItemsHTML = "";
        itemsLibDinamicos.forEach((subItem, subIndex) => {
            miniItemsHTML += `
                <div class="mini-option">
                    <input type="checkbox" class="sub-check-${i}" onchange="verificarEstadoLiberacion(${i})">
                    <span>${subItem}</span>
                </div>
            `;
        });

      contenedor.innerHTML += `
        <div class="check-item-lib" id="cardAeronave${i}">
          <input type="text" id="matEquipo${i}" placeholder="MATRÃCULA EQUIPO ${i}">
          <button type="button" class="btn-camera" onclick="document.getElementById('file${i}').click()">
            <i class="fas fa-camera"></i> AÃ±adir Foto / GalerÃ­a
          </button>
          <input type="file" id="file${i}" accept="image/*" style="display:none" onchange="addFoto(${i})">
          <div id="galeria${i}" class="galeria-lib"></div>
          <div class="mini-grid">${miniItemsHTML}</div>
          <div style="text-align:center; margin-top:5px;">
            <small id="tsLib${i}" style="font-size:12px; color:var(--text); font-weight:bold; opacity:0.5;">Pendiente de liberar</small>
          </div>
        </div>`;
    }
  }

  checklist.forEach((_, index) => {
    document.getElementById(`item${index}`).addEventListener("change", function() {
      if (this.checked) document.getElementById(`hora${index}`).innerText = " âœ” " + new Date().toLocaleTimeString();
    });
  });
}

function verificarEstadoLiberacion(idAvion) {
    const totalItems = misChecklists.Liberacion.length;
    const marcados = document.querySelectorAll(`.sub-check-${idAvion}:checked`).length;
    const card = document.getElementById(`cardAeronave${idAvion}`);
    const labelEstado = document.getElementById(`tsLib${idAvion}`);
    const inputMat = document.getElementById(`matEquipo${idAvion}`);

    if (marcados === totalItems && totalItems > 0) {
        card.classList.add("liberado-ok");
        if (!inputMat.dataset.horaLib) {
             const ahora = new Date();
             inputMat.dataset.horaLib = ahora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        labelEstado.style.opacity = "1";
        labelEstado.style.color = "var(--success)"; 
        labelEstado.innerText = "LIBERADO: " + inputMat.dataset.horaLib;
    } else {
        card.classList.remove("liberado-ok");
        labelEstado.style.opacity = "0.5";
        labelEstado.style.color = "var(--text)";
        labelEstado.innerText = "Pendiente (" + marcados + "/" + totalItems + ")";
        delete inputMat.dataset.horaLib; 
    }
}

function addFoto(i) {
  const fileInput = document.getElementById(`file${i}`);
  const file = fileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = function() {
    const img = new Image();
    img.src = reader.result;
    img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const MAX_WIDTH = 800;
        const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        fotosAeronaves[i].push(canvas.toDataURL('image/jpeg', 0.7));
        renderGaleria(i);
        fileInput.value = ""; 
    }
  }
  reader.readAsDataURL(file);
}

function addFotoObservaciones() {
  const fileInput = document.getElementById('fileObservaciones');
  const file = fileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = function() {
    const img = new Image();
    img.src = reader.result;
    img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const MAX_WIDTH = 800;
        const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        fotosObservaciones.push(canvas.toDataURL('image/jpeg', 0.7));
        renderGaleriaObservaciones();
        fileInput.value = ""; 
    }
  }
  reader.readAsDataURL(file);
}

function renderGaleriaObservaciones() {
  const galeria = document.getElementById('galeriaObservaciones');
  galeria.innerHTML = fotosObservaciones.map((src, index) => `
    <div class="img-wrapper"><img src="${src}" class="img-thumb"><button class="btn-remove-img" onclick="removeFotoObservaciones(${index})">Ã—</button></div>
  `).join('');
}
function removeFotoObservaciones(index) { fotosObservaciones.splice(index, 1); renderGaleriaObservaciones(); }
function renderGaleria(i) {
  const galeria = document.getElementById(`galeria${i}`);
  galeria.innerHTML = fotosAeronaves[i].map((src, index) => `
    <div class="img-wrapper"><img src="${src}" class="img-thumb"><button class="btn-remove-img" onclick="removeFoto(${i}, ${index})">Ã—</button></div>
  `).join('');
}
function removeFoto(i, index) { fotosAeronaves[i].splice(index, 1); renderGaleria(i); }

function validarChecklist() {
  const tipo = localStorage.getItem("tipoJornadaQC");
  let matriculasData = [];
  if (tipo !== "Curso") {
    for (let i = 1; i <= 4; i++) {
      const matInput = document.getElementById(`matEquipo${i}`);
      const mat = matInput.value.trim();
      const checksFaltantes = document.querySelectorAll(`.sub-check-${i}:not(:checked)`);
      if (mat !== "") {
          if (checksFaltantes.length > 0) { alert(`âš ï¸ La aeronave ${mat.toUpperCase()} tiene ${checksFaltantes.length} puntos pendientes.`); return; }
          matriculasData.push({ id: mat.toUpperCase(), hora: matInput.dataset.horaLib || "--:--", fotos: [...fotosAeronaves[i]] });
      }
    }
  }
  const checks = document.querySelectorAll("#listaChecklist > div > input[type='checkbox']");
  if ([...checks].some(c => !c.checked)) { alert("âš ï¸ Tareas de jornada incompletas."); return; }
  const colaborador = JSON.parse(localStorage.getItem("colaboradorQC"));
  const registro = {
    nombre: colaborador.nombre, empleado: colaborador.empleado, fecha: colaborador.fecha,
    jornada: tipo, matriculas: matriculasData, tiempoExtra: localStorage.getItem("esTiempoExtraQC"),
    horaFin: new Date().toLocaleTimeString(), observaciones: document.getElementById("observacionesTurno").value.trim(),
    fotosObservaciones: [...fotosObservaciones]
  };
  const mesClave = `historialQC_${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,"0")}`;
  const historial = JSON.parse(localStorage.getItem(mesClave)) || [];
  historial.push(registro);
  localStorage.setItem(mesClave, JSON.stringify(historial));
  alert("âœ… Turno Finalizado");
  irAHistorial();
}

// --- VISOR DE IMAGENES FULL SCREEN ---
function verImagenGrande(src) {
    document.getElementById("imgFull").src = src;
    document.getElementById("visorImg").style.display = "flex";
}
function cerrarVisor() {
    document.getElementById("visorImg").style.display = "none";
}

// --- EDICIÃ“N DE HISTORIAL ---
function abrirEditor(indice) {
    const mesClave = `historialQC_${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,"0")}`;
    const historial = JSON.parse(localStorage.getItem(mesClave));
    const registro = historial[indice];
    
    indiceEditando = indice;
    document.getElementById("editObservaciones").value = registro.observaciones || "";
    
    // Si ya tiene fotos en observaciones, las cargamos. Si no, array vacÃ­o
    fotosEditando = registro.fotosObservaciones ? [...registro.fotosObservaciones] : [];
    
    renderGaleriaEdicion();
    document.getElementById("modalEditor").style.display = "flex";
}

function cerrarEditor() {
    document.getElementById("modalEditor").style.display = "none";
    indiceEditando = -1;
    fotosEditando = [];
}

function renderGaleriaEdicion() {
    const galeria = document.getElementById("editGaleria");
    galeria.innerHTML = fotosEditando.map((src, index) => `
        <div class="img-wrapper">
            <img src="${src}" class="img-thumb" onclick="verImagenGrande('${src}')">
            <button class="btn-remove-img" onclick="eliminarFotoEdicion(${index})">Ã—</button>
        </div>
    `).join('');
}

function eliminarFotoEdicion(index) {
    fotosEditando.splice(index, 1);
    renderGaleriaEdicion();
}

function addFotoEdicion() {
  const fileInput = document.getElementById('fileEdit');
  const file = fileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = function() {
    const img = new Image();
    img.src = reader.result;
    img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const MAX_WIDTH = 800;
        const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        fotosEditando.push(canvas.toDataURL('image/jpeg', 0.7));
        renderGaleriaEdicion();
        fileInput.value = ""; 
    }
  }
  reader.readAsDataURL(file);
}

function guardarEdicion() {
    if(indiceEditando === -1) return;
    const mesClave = `historialQC_${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,"0")}`;
    const historial = JSON.parse(localStorage.getItem(mesClave));
    
    // Actualizar registro
    historial[indiceEditando].observaciones = document.getElementById("editObservaciones").value;
    historial[indiceEditando].fotosObservaciones = [...fotosEditando];
    
    localStorage.setItem(mesClave, JSON.stringify(historial));
    alert("âœ… Registro actualizado correctamente");
    cerrarEditor();
    cargarHistorialMensual(); // Refrescar vista
}

// --- HISTORIAL ---
function cargarHistorialMensual() {
  const ahora = new Date();
  const mesClave = `historialQC_${ahora.getFullYear()}-${String(ahora.getMonth() + 1).padStart(2, "0")}`;
  const historial = JSON.parse(localStorage.getItem(mesClave)) || [];
  document.getElementById("statJornadas").innerText = historial.length;
  document.getElementById("statExtra").innerText = historial.filter(r => r.tiempoExtra === "SI").length;
  const contenedor = document.getElementById("listaHistorial");
  if (historial.length === 0) { contenedor.innerHTML = "<p style='text-align:center; color:var(--muted);'>No hay registros.</p>"; return; }
  
  // MODIFICADO: AÃ±adido onClick para ver imagen y botÃ³n Editar
  contenedor.innerHTML = historial.map((reg, i) => `
    <div style="padding:15px; border:1px solid #1e293b; margin-bottom:12px; border-radius:15px; background:rgba(2, 6, 23, 0.8);">
      <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <small style="color:var(--accent); font-weight:bold;">${reg.fecha}</small>
        <small style="color:var(--muted)">Fin: ${reg.horaFin}</small>
      </div>
      <strong style="font-size:14px;">${reg.jornada} ${reg.matriculas ? '[' + reg.matriculas.map(m => m.id).join(', ') + ']' : ''}</strong>
      ${reg.matriculas ? reg.matriculas.map(m => `
        <div style="margin-top:8px;"><small style="color:var(--accent)">${m.id} (${m.hora}):</small>
          <div style="display:flex; gap:5px; margin-top:3px; overflow-x:auto;">${m.fotos ? m.fotos.map(f => `<img src="${f}" style="height:35px; border-radius:4px; cursor:pointer;" onclick="verImagenGrande('${f}')">`).join('') : ''}</div>
        </div>`).join('') : ''}
      <div style="margin-top:10px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
          <small style="color:var(--muted); display:block; margin-bottom:4px;">Observaciones:</small>
          <p style="font-size:12px; color:#e2e8f0; margin:0;">${reg.observaciones || "â€”"}</p>
          ${reg.fotosObservaciones && reg.fotosObservaciones.length > 0 ? `<div style="display:flex; gap:5px; margin-top:8px; overflow-x:auto;">${reg.fotosObservaciones.map(f => `<img src="${f}" style="height:50px; border-radius:6px; border:1px solid #475569; cursor:pointer;" onclick="verImagenGrande('${f}')">`).join('')}</div>` : ''}
      </div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button onclick="abrirEditor(${i})" class="btn-warning" style="padding:5px; font-size:10px; height:auto; width:auto; flex:1;"><i class="fas fa-edit"></i> Editar</button>
        <button onclick="eliminarRegistro(${i})" style="padding:5px; background:var(--danger); font-size:10px; height:auto; width:auto; flex:1;"><i class="fas fa-trash"></i> Borrar</button>
      </div>
    </div>`).join("");
}

// --- EXPORTAR: ESTRATEGIA ANEXO FOTOGRAFICO ---
function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const ahora = new Date();
  const mesClave = `historialQC_${ahora.getFullYear()}-${String(ahora.getMonth()+1).padStart(2,"0")}`;
  const h = JSON.parse(localStorage.getItem(mesClave)) || [];
  if(h.length === 0){ alert("No hay datos"); return; }

  doc.setFontSize(16); doc.setTextColor(56, 189, 248);
  doc.text("REPORTE MENSUAL QC", 14, 20);

  // 1. TABLA SOLO DE TEXTO (Limpia y ordenada)
  const body = h.map(r => [
    r.fecha + "\n(" + r.horaFin + ")", 
    r.jornada + (r.matriculas ? "\n" + r.matriculas.map(m => "â€¢ " + m.id + " (" + m.hora + ")").join("\n") : ""), 
    r.observaciones || "â€”"
  ]);

  doc.autoTable({
    startY: 30,
    head: [['Fecha / CulminaciÃ³n', 'Equipos Liberados', 'Observaciones']],
    body: body,
    styles: { fontSize: 9, cellPadding: 3 },
    headStyles: { fillColor: [30, 41, 59] },
    columnStyles: { 0: {cellWidth: 40}, 1: {cellWidth: 60} }
  });

  // 2. GENERACIÃ“N DE HOJAS DE ANEXO FOTOGRÃFICO
  let pageNumber = 1;
   
  h.forEach((reg, index) => {
      // Recolectar todas las fotos de este registro
      let allPhotos = [];
       
      // Fotos de Matriculas
      if(reg.matriculas && Array.isArray(reg.matriculas)){
          reg.matriculas.forEach(m => {
             if(m.fotos && m.fotos.length > 0) {
                 m.fotos.forEach((f, i) => {
                     allPhotos.push({ src: f, label: `Aeronave: ${m.id} - Foto ${i+1}` });
                 });
             }
          });
      }
       
      // Fotos de Observaciones
      if(reg.fotosObservaciones && Array.isArray(reg.fotosObservaciones)){
          reg.fotosObservaciones.forEach((f, i) => {
              allPhotos.push({ src: f, label: `ObservaciÃ³n General - Foto ${i+1}` });
          });
      }

      // Si hay fotos, crear pÃ¡ginas nuevas para ellas
      if(allPhotos.length > 0) {
          doc.addPage(); // Nueva hoja
          doc.setFontSize(14); doc.setTextColor(0, 0, 0);
          doc.text(`Anexo FotogrÃ¡fico - Fecha: ${reg.fecha}`, 14, 15);
           
          let yPos = 25;
          const pageHeight = doc.internal.pageSize.height;
           
          allPhotos.forEach(photo => {
              // Altura de imagen grande: 110mm (casi media hoja)
              const imgHeight = 110; 
              const imgWidth = 170; // Ancho completo margen a margen
               
              // Si no cabe en la hoja actual, aÃ±adir otra
              if (yPos + imgHeight > pageHeight - 10) {
                  doc.addPage();
                  yPos = 20;
              }

              try {
                doc.text(photo.label, 14, yPos - 2);
                doc.addImage(photo.src, 'JPEG', 20, yPos, imgWidth, imgHeight);
                // Marco opcional alrededor de la foto
                doc.setDrawColor(200);
                doc.rect(20, yPos, imgWidth, imgHeight);
              } catch(e) { console.error("Error imagen", e); }
               
              yPos += imgHeight + 15; // Espacio para la siguiente
          });
      }
  });

  doc.save(`Reporte_QC_${mesClave}.pdf`);
}

function filtrarHistorial() {
  const busqueda = document.getElementById("buscadorHistorial").value.toLowerCase();
  const tarjetas = document.querySelectorAll("#listaHistorial > div");
  tarjetas.forEach(t => t.style.display = t.innerText.toLowerCase().includes(busqueda) ? "block" : "none");
}
function irAHistorial(){
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById("pantallaHistorial").style.display = "block";
  cargarHistorialMensual();
}
function eliminarRegistro(i) {
  const mesClave = `historialQC_${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, "0")}`;
  let h = JSON.parse(localStorage.getItem(mesClave));
  h.splice(i, 1);
  localStorage.setItem(mesClave, JSON.stringify(h));
  cargarHistorialMensual();
}
function volverAlInicio(){ document.getElementById("pantallaMenu").style.display = "none"; document.getElementById("pantallaInicio").style.display = "block"; }
function volverAJornada(){ document.getElementById("pantallaTiempoExtra").style.display = "none"; document.getElementById("pantallaMenu").style.display = "block"; }
function volverDesdeChecklist(){ document.getElementById("pantallaChecklist").style.display = "none"; document.getElementById("pantallaMenu").style.display = "block"; }
function nuevaJornada(){ location.reload(); }
function eliminarHistorial(){
  if(confirm("Â¿Borrar todo el mes?")){
    const mesClave = `historialQC_${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,"0")}`;
    localStorage.removeItem(mesClave);
    cargarHistorialMensual();
  }
}
</script>
</body>
</html>
